# =============================================================================
# AWX Instance
# =============================================================================
apiVersion: awx.ansible.com/v1beta1
kind: AWX
metadata:
  name: awx
  namespace: awx
spec:
  # External PostgreSQL configuration
  postgres_configuration_secret: awx-postgres-secret
  
  # AWX admin credentials
  admin_user: admin
  admin_password_secret: awx-admin-secret
  
  # Secret key for encryption (used for database encryption/decryption)
  secret_key_secret: awx-secret-key
  
  # Service configuration
  service_type: ClusterIP
  
  # Ingress - managed manually
  ingress_type: none
  
  # Redis configuration via env vars
  extra_volumes: |
    - name: redis-password
      secret:
        secretName: awx-redis-secret
        items:
          - key: password
            path: redis-password
  
  web_extra_env: |
    - name: REDIS_PASSWORD
      valueFrom:
        secretKeyRef:
          name: awx-redis-secret
          key: password
  
  task_extra_env: |
    - name: REDIS_PASSWORD
      valueFrom:
        secretKeyRef:
          name: awx-redis-secret
          key: password
  
  extra_settings:
    # External Redis configuration - using master node directly via headless service
    - setting: BROKER_URL
      value: "f'redis://:{os.environ.get(\"REDIS_PASSWORD\")}@redis-node-0.redis-headless.redis.svc.cluster.local:6379/0'"
    # Django CACHES configuration for Redis
    - setting: CACHES
      value: "{'default': {'BACKEND': 'django_redis.cache.RedisCache', 'LOCATION': f'redis://:{os.environ.get(\"REDIS_PASSWORD\")}@redis-node-0.redis-headless.redis.svc.cluster.local:6379/1'}}"
  
  # Resource requests/limits
  web_resource_requirements:
    requests:
      cpu: 200m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi
      
  task_resource_requirements:
    requests:
      cpu: 200m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi

  # HA replicas - reduced for cluster capacity
  web_replicas: 1
  task_replicas: 1
