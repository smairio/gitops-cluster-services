# =============================================================================
# Pre-Recovery S3 Cleanup - ArgoCD Sync Hook (runs before Cluster)
# =============================================================================
# This Job runs AFTER ExternalSecrets (-2) but BEFORE the Cluster (0).
# It cleans up any leftover archives from previous recovery attempts.
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: pre-recovery-cleanup
  namespace: postgres
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    argocd.argoproj.io/sync-wave: "-1"  # After ExternalSecrets (-2), before Cluster (0)
spec:
  ttlSecondsAfterFinished: 60
  backoffLimit: 2
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: cleanup
          image: amazon/aws-cli:latest
          env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: hetzner-s3-credentials
                  key: ACCESS_KEY_ID
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: hetzner-s3-credentials
                  key: ACCESS_SECRET_KEY
          command:
            - /bin/sh
            - -c
            - |
              set -e
              BUCKET="awx-postgres-backups"
              PREFIX="clusters/postgres-cluster"
              ENDPOINT="https://fsn1.your-objectstorage.com"
              
              echo "=== Pre-Recovery S3 Cleanup (ArgoCD PreSync Hook) ==="
              
              echo "Cleaning up postgres-cluster-recovered folder..."
              aws s3 rm "s3://${BUCKET}/${PREFIX}/postgres-cluster-recovered/" \
                --recursive --endpoint-url="$ENDPOINT" 2>/dev/null || echo "(already clean)"
              
              echo "Cleanup complete - ready for recovery!"
