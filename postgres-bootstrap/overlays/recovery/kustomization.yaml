# =============================================================================
# Recovery Overlay - Restore PostgreSQL Cluster from Backup
# =============================================================================
# Use this overlay to RESTORE a cluster from S3 backup
#
# All backups are stored in the same folder (postgres-cluster/) with unique
# Backup IDs. You can list all backups and choose which one to restore.
#
# Options:
#   1. recoveryTarget: {} - Restore to latest available point
#   2. recoveryTarget.targetTime - Restore to specific point in time (PITR)
#   3. recoveryTarget.backupID - Restore specific backup by ID
# =============================================================================
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: postgres

resources:
  - ../../base

patches:
  - target:
      kind: Cluster
      name: postgres-cluster
    patch: |-
      # ======================================================================
      # Skip the empty WAL archive check - allows recovery to continue
      # writing to the same folder where backups are stored
      # ======================================================================
      - op: add
        path: /metadata/annotations/cnpg.io~1skipEmptyWalArchiveCheck
        value: "enabled"
      - op: add
        path: /spec/bootstrap
        value:
          recovery:
            # Use the Barman Cloud Plugin ObjectStore for recovery
            source: postgres-cluster-backup
            # ================================================================
            # RECOVERY TARGET OPTIONS (uncomment ONE):
            # ================================================================
            # Using first backup - the second backup (20260130T110733) has missing WALs
            recoveryTarget:
              backupID: "20260130T083428"
            # ================================================================
      - op: add
        path: /spec/externalClusters
        value:
          - name: postgres-cluster-backup
            plugin:
              name: barman-cloud.cloudnative-pg.io
              parameters:
                barmanObjectName: hetzner-s3-store
                serverName: postgres-cluster
