# =============================================================================
# PostgreSQL Bootstrap - ArgoCD Application
# =============================================================================
# Two modes available:
#
# INIT MODE (default - for fresh cluster OR after recovery):
#   path: postgres-bootstrap/overlays/init
#
# RECOVERY MODE (restore from backup):
#   path: postgres-bootstrap/overlays/recovery
#   Edit kustomization.yaml to set backupID or targetTime for PITR
# =============================================================================
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: postgres-bootstrap
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
spec:
  project: default

  destination:
    server: https://kubernetes.default.svc
    namespace: postgres

  source:
    repoURL: https://github.com/smairio/gitops-cluster-services.git
    targetRevision: main
    # =========================================================================
    # CHANGE THIS PATH TO SWITCH BETWEEN MODES
    # =========================================================================
    # For INIT (fresh cluster or after recovery): postgres-bootstrap/overlays/init
    # For RECOVERY (from backup):                 postgres-bootstrap/overlays/recovery
    # =========================================================================
    path: postgres-bootstrap/overlays/recovery

  # ===========================================================================
  # Ignore differences for ESO-managed secrets and CNPG-managed resources
  # ===========================================================================
  ignoreDifferences:
    - group: ""
      kind: Secret
      jsonPointers:
        - /data
        - /metadata/annotations
        - /metadata/labels
      managedFieldsManagers:
        - external-secrets
    - group: external-secrets.io
      kind: ExternalSecret
      jqPathExpressions:
        - .status
        - .spec.data[].remoteRef.conversionStrategy
        - .spec.data[].remoteRef.decodingStrategy
        - .spec.data[].remoteRef.metadataPolicy
        - .spec.target.deletionPolicy
        - .metadata.finalizers
    # CloudNativePG Cluster - operator adds many default fields
    - group: postgresql.cnpg.io
      kind: Cluster
      jqPathExpressions:
        - .status
        - .spec.bootstrap.recovery.database
        - .spec.bootstrap.recovery.owner
        - .spec.externalClusters[].plugin.enabled
        - .spec.externalClusters[].plugin.isWALArchiver
        - .spec.plugins[].enabled
        - .spec.failoverDelay
        - .spec.enablePDB
        - .spec.logLevel
        - .spec.maxSyncReplicas
        - .spec.minSyncReplicas
        - .spec.postgresGID
        - .spec.postgresUID
        - .spec.affinity.podAntiAffinityType
        - .spec.managed.roles[].connectionLimit
        - .spec.monitoring.disableDefaultQueries
        - .spec.monitoring.customQueriesConfigMap

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
