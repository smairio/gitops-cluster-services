# =============================================================================
# Metricbeat DaemonSet - Per-Node Metrics (ECK Managed)
# =============================================================================
# Runs on ALL nodes to collect node-level system + kubelet metrics.
# The kubelet metricsets (node, pod, container, volume, system) connect
# to the local node's kubelet API at ${NODE_NAME}:10250.
# =============================================================================
apiVersion: beat.k8s.elastic.co/v1beta1
kind: Beat
metadata:
  name: metricbeat
  namespace: elastic-system
spec:
  type: metricbeat
  version: 8.15.3

  # Reference the Elasticsearch cluster
  elasticsearchRef:
    name: elk

  # Reference Kibana for dashboard auto-setup
  kibanaRef:
    name: elk

  config:
    # ── System Module ──
    metricbeat.modules:
      - module: system
        period: 30s
        metricsets:
          - cpu
          - load
          - memory
          - network
          - process
          - process_summary
          - socket_summary
          - filesystem
          - fsstat
          - diskio
        process.include_top_n:
          by_cpu: 5
          by_memory: 5
        processes: [".*"]

      # ── Kubernetes Kubelet Module (per-node) ──
      - module: kubernetes
        period: 30s
        host: ${NODE_NAME}
        metricsets:
          - node
          - system
          - pod
          - container
          - volume
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        hosts:
          - "https://${NODE_NAME}:10250"
        ssl.verification_mode: "none"

    # Processors
    processors:
      - add_cloud_metadata: {}
      - add_host_metadata: {}
      - add_kubernetes_metadata:
          host: ${NODE_NAME}

    # Index template: raise field limit (default 10000 is too low for metricbeat
    # which maps ALL modules including unused ones like aws/gcp/mongodb)
    setup.template.overwrite: true
    setup.template.settings:
      index.mapping.total_fields.limit: 20000

    # ILM for automatic index cleanup
    setup.ilm.enabled: true
    setup.ilm.rollover_alias: "metricbeat"
    setup.ilm.pattern: "{now/d}-000001"
    setup.ilm.policy_name: "metricbeat"

    # Auto-load Kibana dashboards
    setup.dashboards.enabled: true

  # DaemonSet deployment — runs on every node
  daemonSet:
    podTemplate:
      spec:
        # Tolerate ALL taints so metricbeat runs on every node
        tolerations:
          - operator: Exists

        serviceAccountName: metricbeat
        automountServiceAccountToken: true
        hostNetwork: true
        dnsPolicy: ClusterFirstWithHostNet

        containers:
          - name: metricbeat
            securityContext:
              runAsUser: 0
            resources:
              requests:
                cpu: 50m
                memory: 128Mi
              limits:
                cpu: 200m
                memory: 256Mi
            env:
              - name: NODE_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: spec.nodeName
            volumeMounts:
              - name: proc
                mountPath: /hostfs/proc
                readOnly: true
              - name: cgroup
                mountPath: /hostfs/sys/fs/cgroup
                readOnly: true

        volumes:
          - name: proc
            hostPath:
              path: /proc
          - name: cgroup
            hostPath:
              path: /sys/fs/cgroup

---
# =============================================================================
# Metricbeat Deployment - Cluster-Wide State Metrics (ECK Managed)
# =============================================================================
# Single replica that scrapes kube-state-metrics + Kubernetes events.
# Must NOT run as DaemonSet to avoid 7x duplicate state_* documents.
# =============================================================================
apiVersion: beat.k8s.elastic.co/v1beta1
kind: Beat
metadata:
  name: metricbeat-state
  namespace: elastic-system
spec:
  type: metricbeat
  version: 8.15.3

  elasticsearchRef:
    name: elk

  config:
    metricbeat.modules:
      # ── Kubernetes State Metrics (from kube-state-metrics service) ──
      - module: kubernetes
        period: 30s
        metricsets:
          - state_node
          - state_deployment
          - state_daemonset
          - state_replicaset
          - state_pod
          - state_container
          - state_statefulset
          - state_cronjob
          - state_resourcequota
          - state_service
          - state_persistentvolume
          - state_persistentvolumeclaim
          - state_storageclass
        hosts:
          - "monitoring-kube-state-metrics.monitoring.svc.cluster.local:8080"

      # ── Kubernetes Events ──
      - module: kubernetes
        period: 30s
        metricsets:
          - event

    processors:
      - add_cloud_metadata: {}
      - add_host_metadata: {}

    # Index template: raise field limit (matches DaemonSet setting)
    setup.template.overwrite: true
    setup.template.settings:
      index.mapping.total_fields.limit: 20000

    setup.ilm.enabled: true
    setup.ilm.rollover_alias: "metricbeat"
    setup.ilm.pattern: "{now/d}-000001"
    setup.ilm.policy_name: "metricbeat"

  # Single-replica Deployment (NOT DaemonSet)
  deployment:
    replicas: 1
    podTemplate:
      spec:
        serviceAccountName: metricbeat
        automountServiceAccountToken: true
        dnsPolicy: ClusterFirstWithHostNet

        # Place on ELK nodes alongside ES
        nodeSelector:
          node-type: elk
        tolerations:
          - key: "dedicated"
            operator: "Equal"
            value: "elk"
            effect: "NoSchedule"

        containers:
          - name: metricbeat
            securityContext:
              runAsUser: 0
            resources:
              requests:
                cpu: 50m
                memory: 128Mi
              limits:
                cpu: 200m
                memory: 256Mi

---
# =============================================================================
# Metricbeat RBAC
# =============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: metricbeat
  namespace: elastic-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: metricbeat
rules:
  - apiGroups: [""]
    resources:
      - namespaces
      - pods
      - nodes
      - nodes/metrics
      - nodes/stats
      - events
      - services
      - persistentvolumes
      - persistentvolumeclaims
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources:
      - deployments
      - replicasets
      - daemonsets
      - statefulsets
    verbs: ["get", "list", "watch"]
  - apiGroups: ["batch"]
    resources:
      - jobs
      - cronjobs
    verbs: ["get", "list", "watch"]
  - apiGroups: ["storage.k8s.io"]
    resources:
      - storageclasses
    verbs: ["get", "list", "watch"]
  - nonResourceURLs: ["/metrics"]
    verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: metricbeat
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: metricbeat
subjects:
  - kind: ServiceAccount
    name: metricbeat
    namespace: elastic-system
